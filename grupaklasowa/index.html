<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grupa klasowa - Supabase</title>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://veyoeotbeqvwuxkzndwk.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZleW9lb3RiZXF2d3V4a3puZHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTEyNDgsImV4cCI6MjA3Mzg2NzI0OH0.ahFOpeuHBio0CsXC6YK_-lv066OArsCaByU2a4uSMHw'
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

let currentUser = null;
const brzydkieSlowa = ["kurwa","chuj","pizda","idiota","debil"];

// upload pliku do Storage
async function uploadFile(file, folder){
  if(!file) return null
  const fileName = `${folder}/${Date.now()}_${file.name}`
  const { error } = await supabase.storage.from('chat-files').upload(fileName, file)
  if(error){ console.log(error); return null }
  const { publicUrl } = supabase.storage.from('chat-files').getPublicUrl(fileName)
  return publicUrl
}

// login / rejestracja
async function login(){
  const username = document.getElementById('username').value.trim()
  const password = document.getElementById('password').value.trim()
  const avatarFile = document.getElementById('avatar').files[0]

  if(!username || !password){ alert("Podaj login i hasło"); return }
  if(brzydkieSlowa.some(w=>username.toLowerCase().includes(w))){ alert("Nazwa zawiera niedozwolone słowo"); return }

  const { data:userData, error } = await supabase.from('users').select('*').eq('username',username).single()
  if(error && error.code!=="PGRST116"){ console.log(error); return }

  if(userData){
    if(userData.password!==password){ alert("Hasło niepoprawne"); return }
    currentUser = userData
  } else {
    const avatarLink = await uploadFile(avatarFile, 'avatars')
    const { data:newUser } = await supabase.from('users').insert([{username,password,avatar_url:avatarLink}]).select().single()
    currentUser = newUser
  }

  localStorage.setItem('user', JSON.stringify(currentUser))

  document.getElementById('login').style.display='none'
  document.getElementById('chat').style.display='block'
  subscribeMessages()
}

// wysyłanie wiadomości
async function sendMessage(){
  const text = document.getElementById('message').value
  const fileInput = document.getElementById('file')
  let fileUrl = null, fileType = null
  if(fileInput.files[0]){
    fileUrl = await uploadFile(fileInput.files[0],'chat-files')
    fileType = fileInput.files[0].type
  }

  await supabase.from('messages').insert([{
    user_id: currentUser.id,
    text:text,
    file_url:fileUrl,
    file_type:fileType
  }])
  document.getElementById('message').value=""
  fileInput.value=""
}

// dodawanie komentarza
async function addComment(message_id, text){
  if(!text) return
  await supabase.from('comments').insert([{
    message_id,
    user_id: currentUser.id,
    text
  }])
}

// usuwanie własnej wiadomości
async function deleteMessage(msgId){
  await supabase.from('messages').delete().eq('id', msgId).eq('user_id', currentUser.id)
}

// renderowanie wiadomości
function renderMessage(msg, container){
  const div = document.createElement('div')
  div.className='message'
  const avatarImg = msg.user_id.avatar_url ? `<img src="${msg.user_id.avatar_url}" class="msg-avatar">` : ''
  div.innerHTML=`${avatarImg}<strong>${msg.user_id.username}:</strong> ${msg.text||''}`
  if(msg.file_url){
    if(msg.file_type.startsWith('image')) div.innerHTML+=`<br><img src="${msg.file_url}" width="200"/>`
    else if(msg.file_type.startsWith('video')) div.innerHTML+=`<br><video src="${msg.file_url}" controls width="200"></video>`
  }

  // przycisk usuwania jeśli własna wiadomość
  if(msg.user_id.id === currentUser.id){
    const delBtn = document.createElement('button')
    delBtn.textContent="Usuń"
    delBtn.onclick=()=>{ deleteMessage(msg.id) }
    div.appendChild(delBtn)
  }

  // komentarze
  const commentsDiv = document.createElement('div')
  commentsDiv.className='comments'
  div.appendChild(commentsDiv)

  const input = document.createElement('input')
  input.placeholder="Dodaj komentarz..."
  const btn = document.createElement('button')
  btn.textContent="➤"
  btn.onclick=()=>{ addComment(msg.id,input.value); input.value="" }
  const formDiv = document.createElement('div')
  formDiv.className='comment-form'
  formDiv.appendChild(input)
  formDiv.appendChild(btn)
  div.appendChild(formDiv)

  container.prepend(div)

  // realtime komentarze
  supabase.channel(`comments:message_id=eq.${msg.id}`)
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments', filter: `message_id=eq.${msg.id}` }, payload=>{
      const c = payload.new
      const commentDiv = document.createElement('div')
      commentDiv.className='comment'
      commentDiv.innerHTML=`<em>${currentUser.username}:</em> ${c.text}`
      commentsDiv.appendChild(commentDiv)
    }).subscribe()
}

// subskrypcja wiadomości
async function subscribeMessages(){
  const messagesDiv = document.getElementById('messages')

  // pobranie historii od najnowszych
  const { data, error } = await supabase.from('messages').select(`*,user_id(*)`).order('inserted_at',{ascending:false})
  if(data) data.forEach(msg => renderMessage(msg, messagesDiv))

  // realtime nowych wiadomości
  supabase.channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload=>{
      renderMessage(payload.new, messagesDiv)
    }).subscribe()
}

// persistent login przy ładowaniu
window.onload = ()=>{
  const savedUser = localStorage.getItem('user')
  if(savedUser){
    currentUser = JSON.parse(savedUser)
    document.getElementById('login').style.display='none'
    document.getElementById('chat').style.display='block'
    subscribeMessages()
  }
}

document.getElementById('loginBtn').onclick=login
document.getElementById('sendBtn').onclick=sendMessage
</script>
<style>
body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:0;}
#login,#chat{max-width:600px;margin:auto;padding:20px;}
#chat{display:none;}
#messages{height:400px;overflow-y:auto;border:1px solid #ccc;background:#fff;padding:10px;}
.message{margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:8px;display:flex;flex-direction:column;gap:5px;}
.msg-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;}
.comments{margin-left:50px;margin-top:5px;}
.comment{font-size:0.9em;color:#333;}
.comment-form{display:flex;gap:5px;margin-left:50px;margin-top:5px;}
textarea,input{width:100%;padding:5px;}
button{padding:5px 10px;}
</style>
</head>
<body>
<div id="login">
<h2>Logowanie / Rejestracja</h2>
<input type="text" id="username" placeholder="Nazwa użytkownika"><br><br>
<input type="password" id="password" placeholder="Hasło"><br><br>
<label>Avatar (opcjonalny):</label><br>
<input type="file" id="avatar" accept="image/*"><br><br>
<button id="loginBtn">Wejdź</button>
</div>

<div id="chat">
<h2>Grupa klasowa</h2>
<div id="messages"></div>
<textarea id="message" placeholder="Wpisz wiadomość"></textarea><br>
<input type="file" id="file" accept="image/*,video/*"><br><br>
<button id="sendBtn">Wyślij</button>
</div>
</body>
</html>
