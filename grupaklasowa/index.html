<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grupa klasowa</title>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://veyoeotbeqvwuxkzndwk.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZleW9lb3RiZXF2d3V4a3puZHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTEyNDgsImV4cCI6MjA3Mzg2NzI0OH0.ahFOpeuHBio0CsXC6YK_-lv066OArsCaByU2a4uSMHw'
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

let currentUser = null;
const brzydkieSlowa = ["kurwa","chuj","pizda","idiota","debil"];
let lastMessages = new Map();

// upload pliku do Storage
async function uploadFile(file, folder){
  if(!file) return null
  const fileName = `${folder}/${Date.now()}_${file.name}`
  const { error } = await supabase.storage.from('chat-files').upload(fileName, file)
  if(error){ console.log(error); return null }
  const { data } = supabase.storage.from('chat-files').getPublicUrl(fileName)
  return data.publicUrl
}

// login / rejestracja
async function login(){
  const username = document.getElementById('username').value.trim()
  const password = document.getElementById('password').value.trim()
  if(!username || !password){ alert("Podaj login i hasło"); return }
  if(brzydkieSlowa.some(w=>username.toLowerCase().includes(w))){ alert("Nazwa zawiera niedozwolone słowo"); return }

  const { data:userData, error } = await supabase.from('users').select('*').eq('username',username).single()
  if(error && error.code!=="PGRST116"){ console.log(error); return }

  if(userData){
    if(userData.password!==password){ alert("Hasło niepoprawne"); return }
    currentUser = userData
  } else {
    const { data:newUser } = await supabase.from('users').insert([{username,password}]).select().single()
    currentUser = newUser
  }

  localStorage.setItem('user', JSON.stringify(currentUser))
  document.getElementById('login').style.display='none'
  document.getElementById('chat').style.display='block'
  startPolling()
}

// wysyłanie wiadomości
async function sendMessage(){
  const text = document.getElementById('message').value
  const fileInput = document.getElementById('file')
  let fileUrl = null, fileType = null
  if(fileInput.files[0]){
    fileUrl = await uploadFile(fileInput.files[0],'chat-files')
    fileType = fileInput.files[0].type
  }

  await supabase.from('messages').insert([{
    user_id: currentUser.id,
    text:text,
    file_url:fileUrl,
    file_type:fileType
  }])
  document.getElementById('message').value=""
  fileInput.value=""
}

// dodawanie komentarza
async function addComment(message_id, text){
  if(!text) return
  await supabase.from('comments').insert([{
    message_id,
    user_id: currentUser.id,
    text
  }])
}

// usuwanie własnej wiadomości
async function deleteMessage(msgId){
  await supabase.from('messages').delete().eq('id', msgId).eq('user_id', currentUser.id)
}

// renderowanie wiadomości
function renderMessage(msg, container){
  if(lastMessages.has(msg.id)) return
  lastMessages.set(msg.id, msg)

  const div = document.createElement('div')
  div.className='message'
  div.dataset.id = msg.id
  div.innerHTML=`<strong>${msg.user_id.username}:</strong> ${msg.text||''}`
  if(msg.file_url){
    if(msg.file_type.startsWith('image')) div.innerHTML+=`<br><img src="${msg.file_url}" width="200" style="border-radius:8px;"/>`
    else if(msg.file_type.startsWith('video')) div.innerHTML+=`<br><video src="${msg.file_url}" controls width="200" style="border-radius:8px;"></video>`
  }

  if(msg.user_id.id === currentUser.id){
    const delBtn = document.createElement('button')
    delBtn.textContent="Usuń"
    delBtn.className='del-btn'
    delBtn.onclick=()=>{ deleteMessage(msg.id) }
    div.appendChild(delBtn)
  }

  const commentsDiv = document.createElement('div')
  commentsDiv.className='comments'
  div.appendChild(commentsDiv)

  const formDiv = document.createElement('div')
  formDiv.className='comment-form'
  formDiv.appendChild(input)
  formDiv.appendChild(btn)
  div.appendChild(formDiv)

  container.prepend(div)
  fetchComments(msg.id, commentsDiv)
}

// fetch komentarzy
async function fetchComments(msgId, container){
  const { data } = await supabase.from('comments').select(`*,user_id(*)`).eq('message_id', msgId).order('inserted_at',{ascending:true})
  data.forEach(c=>{
    const commentDiv = document.createElement('div')
    commentDiv.className='comment'
    commentDiv.innerHTML=`<em>${c.user_id.username}:</em> ${c.text}`
    container.appendChild(commentDiv)
  })
}

// polling co 1 sekundę
function startPolling(){
  const container = document.getElementById('messages')
  async function poll(){
    const { data } = await supabase.from('messages').select(`*,user_id(*)`).order('inserted_at',{ascending:false})
    const currentIds = new Set()
    data.forEach(msg=>{
      currentIds.add(msg.id)
      if(!lastMessages.has(msg.id)) renderMessage(msg, container)
    })
    lastMessages.forEach((v, id)=>{
      if(!currentIds.has(id)){
        const div = document.querySelector(`.message[data-id='${id}']`)
        if(div) div.remove()
        lastMessages.delete(id)
      }
    })
    setTimeout(poll, 1000)
  }
  poll()
}

// persistent login
window.onload = ()=>{
  const savedUser = localStorage.getItem('user')
  if(savedUser){
    currentUser = JSON.parse(savedUser)
    document.getElementById('login').style.display='none'
    document.getElementById('chat').style.display='block'
    startPolling()
  }
}

document.getElementById('loginBtn').onclick=login
document.getElementById('sendBtn').onclick=sendMessage
</script>
<style>
body{font-family:Arial,sans-serif;background:#e0e7ff;margin:0;padding:0;}
#login,#chat{max-width:700px;margin:20px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
#chat{display:none;}
#messages{height:400px;overflow-y:auto;border:1px solid #ccc;background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:10px;}
.message{margin-bottom:15px;border-bottom:1px solid #ddd;padding:10px;border-radius:8px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.05);}
.comments{margin-top:8px;margin-left:15px;font-size:0.9em;color:#555;}
.comment-form{display:flex;gap:5px;margin-top:5px;}
textarea,input{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;outline:none;}
button{padding:6px 12px;border:none;border-radius:6px;background:#4f46e5;color:#fff;cursor:pointer;}
button:hover{background:#3730a3;}
.del-btn{background:#ef4444;margin-left:10px;}
.del-btn:hover{background:#b91c1c;}
.comment-btn{background:#10b981;}
.comment-btn:hover{background:#047857;}
</style>
</head>
<body>
<div id="login">
<h2>Logowanie / Rejestracja</h2>
<input type="text" id="username" placeholder="Nazwa użytkownika"><br><br>
<input type="password" id="password" placeholder="Hasło"><br><br>
<button id="loginBtn">Wejdź</button>
</div>

<div id="chat">
<h2>Grupa klasowa</h2>
<div id="messages"></div>
<textarea id="message" placeholder="Wpisz wiadomość"></textarea><br>
<input type="file" id="file" accept="image/*,video/*"><br><br>
<button id="sendBtn">Wyślij</button>
</div>
</body>
</html>
