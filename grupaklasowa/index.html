<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grupa klasowa</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuna4EaP0VsS6Y83ljIgk_cWhbeFNufd4",
  authDomain: "grupa-klasowa.firebaseapp.com",
  databaseURL: "https://grupa-klasowa-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "grupa-klasowa",
  storageBucket: "grupa-klasowa.firebasestorage.app",
  messagingSenderId: "610927358293",
  appId: "1:610927358293:web:62fd6038850e9232c97fdc",
  measurementId: "G-1L927SZE5K"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = null;
let avatarData = null;

// Lista niedozwolonych słów w nazwie użytkownika
const brzydkieSlowa = ["kurwa","chuj","pizda","idiota","debil"]; 

function encodeFileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}

async function loadAvatar(username) {
  const snap = await get(ref(db, "users/" + username + "/avatar"));
  return snap.exists() ? snap.val() : null;
}

document.addEventListener("DOMContentLoaded", () => {
  const loginBtn = document.getElementById("loginBtn");
  const sendBtn = document.getElementById("sendBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const messagesDiv = document.getElementById("messages");
  const usersDiv = document.getElementById("users");

  // Logowanie / Rejestracja
  loginBtn.onclick = async () => {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const avatarFile = document.getElementById("avatar").files[0];

    if (!username || !password) { alert("Podaj nazwę użytkownika i hasło"); return; }

    // Sprawdzanie brzydkich słów
    const lower = username.toLowerCase();
    if (brzydkieSlowa.some(w => lower.includes(w))) {
      alert("Nazwa użytkownika zawiera niedozwolone słowo");
      return;
    }

    if (avatarFile) avatarData = await encodeFileToBase64(avatarFile);

    const userRef = ref(db, "users/" + username);
    const snap = await get(userRef);

    if (snap.exists()) {
      const data = snap.val();
      if (data.password !== password) { alert("Hasło niepoprawne"); return; }
      if (!data.avatar && avatarData) await set(ref(db, "users/" + username + "/avatar"), avatarData);
    } else {
      await set(userRef, { password, avatar: avatarData || null });
    }

    currentUser = username;
    await set(ref(db, "status/" + username), { online: true, lastActive: Date.now() });

    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
  };

  // Wyświetlanie wiadomości
  const messagesRef = ref(db, "messages");
  function renderMessages(data) {
    messagesDiv.innerHTML = "";
    Object.entries(data || {}).forEach(async ([msgId, m]) => {
      const msg = document.createElement("div");
      msg.className = "message";

      let userAvatar = m.avatar || (m.username ? await loadAvatar(m.username) : null);
      userAvatar = userAvatar ? `<img src="${userAvatar}" class="msg-avatar"/>` : "";
      msg.innerHTML = `${userAvatar}<strong>${m.username}:</strong> ${m.text || ""}`;

      if (m.file) {
        if (m.file.startsWith("data:video")) msg.innerHTML += `<br><video src="${m.file}" controls width="200"></video>`;
        else if (m.file.startsWith("data:image")) msg.innerHTML += `<br><img src="${m.file}" width="200"/>`;
      }

      const commentsDiv = document.createElement("div");
      commentsDiv.className = "comments";
      if (m.comments) {
        Object.values(m.comments).forEach(c => {
          const cDiv = document.createElement("div");
          cDiv.className = "comment";
          cDiv.innerHTML = `<em>${c.username}:</em> ${c.text}`;
          commentsDiv.appendChild(cDiv);
        });
      }

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Dodaj komentarz...";
      const btn = document.createElement("button");
      btn.textContent = "➤";
      btn.onclick = async () => {
        if (!input.value) return;
        await push(ref(db, `messages/${msgId}/comments`), {
          username: currentUser,
          text: input.value,
          timestamp: Date.now()
        });
        input.value = "";
      };

      const form = document.createElement("div");
      form.className = "comment-form";
      form.appendChild(input);
      form.appendChild(btn);

      msg.appendChild(commentsDiv);
      msg.appendChild(form);
      messagesDiv.appendChild(msg);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Natychmiastowe wczytanie historii
  get(messagesRef).then(snapshot => renderMessages(snapshot.val()));
  onValue(messagesRef, snapshot => renderMessages(snapshot.val()));

  // Lista online
  onValue(ref(db, "status"), snapshot => {
    usersDiv.innerHTML = "<h3>Użytkownicy online:</h3>";
    const data = snapshot.val() || {};
    Object.entries(data).forEach(async ([user, s]) => {
      if (s.online) {
        const uDiv = document.createElement("div");
        uDiv.className = "user-item";
        const avatar = await loadAvatar(user);
        uDiv.innerHTML = avatar ? `<img src="${avatar}" class="user-avatar"/> ${user}` : user;
        usersDiv.appendChild(uDiv);
      }
    });
  });

  // Wysyłanie wiadomości
  sendBtn.onclick = async () => {
    if (!currentUser) { alert("Nie jesteś zalogowany"); return; }
    const text = document.getElementById("message").value;
    const fileInput = document.getElementById("file");
    let fileBase64 = null;
    if (fileInput.files[0]) fileBase64 = await encodeFileToBase64(fileInput.files[0]);

    await push(messagesRef, {
      username: currentUser,
      avatar: avatarData || null,
      text: text,
      file: fileBase64,
      timestamp: Date.now()
    });

    document.getElementById("message").value = "";
    fileInput.value = "";
  };

  // Wylogowanie
  logoutBtn.onclick = async () => {
    if (!currentUser) return;
    await set(ref(db, "status/" + currentUser), { online: false, lastActive: Date.now() });
    currentUser = null;
    document.getElementById("chat").style.display = "none";
    document.getElementById("login").style.display = "block";
  };
});
</script>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0; }
#login, #chat { max-width: 600px; margin: auto; padding: 20px; }
#chat { display: none; }
#messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; background: white; padding: 10px; }
.message { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; display: flex; align-items: flex-start; gap: 8px; }
.msg-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
.comments { margin-left: 50px; margin-top: 5px; }
.comment { font-size: 0.9em; color: #333; }
.comment-form { display: flex; gap: 5px; margin-left: 50px; margin-top: 5px; }
textarea, input { width: 100%; padding: 5px; }
button { padding: 5px 10px; }
#users { background: #fff; border: 1px solid #ccc; margin-top: 10px; padding: 10px; }
.user-avatar { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; margin-right: 5px; vertical-align: middle; }
</style>
</head>
<body>
<div id="login">
<h2>Logowanie / Rejestracja</h2>
<input type="text" id="username" placeholder="Nazwa użytkownika"><br><br>
<input type="password" id="password" placeholder="Hasło"><br><br>
<label>Avatar (opcjonalny):</label><br>
<input type="file" id="avatar" accept="image/*"><br><br>
<button id="loginBtn">Wejdź</button>
</div>

<div id="chat">
<h2>Grupa klasowa</h2>
<div id="users"></div>
<div id="messages"></div>
<textarea id="message" placeholder="Wpisz wiadomość"></textarea><br>
<input type="file" id="file" accept="image/*,video/*"><br><br>
<button id="sendBtn">Wyślij</button>
<button id="logoutBtn">Wyloguj</button>
</div>
</body>
</html>
