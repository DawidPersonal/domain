<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Multi-File CMS</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; }
  #sidebar { width: 200px; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
  #file-list { flex: 1; overflow-y: auto; }
  #file-list button { width: 100%; padding: 8px; border: none; background: #f0f0f0; cursor: pointer; text-align: left; }
  #file-list button:hover { background: #ddd; }
  #editor-container { flex: 1; display: flex; flex-direction: column; }
  #editor { flex: 1; width: 100%; font-family: monospace; font-size: 14px; padding: 10px; border: none; resize: none; }
  #deploy { padding: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; font-size: 16px; }
  #preview-container { flex: 1; border: none; }
  iframe { width: 100%; height: 50%; border: none; }
</style>
</head>
<body>

<div id="sidebar">
  <h3 style="text-align:center;">Files</h3>
  <div id="file-list"></div>
</div>

<div id="editor-container">
  <textarea id="editor" placeholder="Select a file to load..."></textarea>
  <button id="deploy">Deploy to GitHub</button>
  <iframe id="preview"></iframe>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Markdown support -->

<script>
// ===== CONFIG =====
const GITHUB_OWNER = 'DawidPersonal';
const GITHUB_REPO = 'domain';
const BRANCH = 'main';
let FILE_PATH = 'dist/index.html'; // default file
const GITHUB_TOKEN = prompt("Enter your GitHub personal access token:");

// DOM elements
const editor = document.getElementById('editor');
const preview = document.getElementById('preview');
const fileListContainer = document.getElementById('file-list');

// ===== HELPER FUNCTIONS =====

// Update live preview
function updatePreview() {
    if(FILE_PATH.endsWith('.md')) {
        preview.srcdoc = marked.parse(editor.value);
    } else {
        preview.srcdoc = editor.value;
    }
}

editor.addEventListener('input', updatePreview);

// Load a file from GitHub
async function loadFile(path) {
    FILE_PATH = path;
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}?ref=${BRANCH}`);
        const data = await response.json();
        if (data.content) {
            const decoded = atob(data.content);
            editor.value = decoded;
            updatePreview();
        } else {
            editor.value = '';
            updatePreview();
        }
    } catch (err) {
        console.error('Error loading file:', err);
        alert('Failed to load file. Check console.');
    }
}

// List files from a folder in GitHub repo
async function listFiles(path = 'dist') {
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}?ref=${BRANCH}`);
        const files = await response.json();

        if (!Array.isArray(files)) {
            console.error('GitHub API did not return a list of files:', files);
            alert('Failed to list files. Make sure the folder exists in your repo.');
            return;
        }

        fileListContainer.innerHTML = '';
        const editableFiles = files.filter(file => file.type === 'file' && (file.name.endsWith('.html') || file.name.endsWith('.md')));

        if (editableFiles.length === 0) {
            alert('No editable files found in the folder.');
            return;
        }

        editableFiles.forEach(file => {
            const btn = document.createElement('button');
            btn.textContent = file.name;
            btn.onclick = () => loadFile(`${path}/${file.name}`);
            fileListContainer.appendChild(btn);
        });

        loadFile(`${path}/${editableFiles[0].name}`); // load first file
    } catch (err) {
        console.error('Error listing files:', err);
        alert('Failed to list files. Check console.');
    }
}

// Deploy updated file to GitHub
document.getElementById('deploy').addEventListener('click', async () => {
    try {
        // Get SHA of current file
        const getResp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}?ref=${BRANCH}`, {
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
        });
        const existingFile = await getResp.json();
        const sha = existingFile.sha;

        // Push changes
        const putResp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Update ${FILE_PATH} via Live CMS`,
                content: btoa(editor.value),
                branch: BRANCH,
                sha: sha
            })
        });

        const result = await putResp.json();
        if(putResp.ok){
            alert('✅ Successfully deployed!');
        } else {
            console.error(result);
            alert('❌ Deployment failed. Check console.');
        }
    } catch (err) {
        console.error(err);
        alert('❌ Deployment error. See console.');
    }
});

// ===== INIT =====
listFiles('dist'); // adjust folder if needed
</script>

</body>
</html>
