<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Website Editor</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
  #sidebar { width: 220px; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
  #file-list { flex: 1; overflow-y: auto; }
  #file-list button { width: 100%; padding: 8px; border: none; background: #f0f0f0; cursor: pointer; text-align: left; }
  #file-list button:hover { background: #ddd; }
  #editor-container { flex: 1; display: flex; flex-direction: column; }
  #editor { flex: 1; width: 100%; font-family: monospace; font-size: 14px; padding: 10px; border: none; resize: none; }
  #deploy { padding: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; font-size: 16px; }
  iframe { width: 100%; height: 50%; border: none; }
  #overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:100; }
  #overlay-box { background:white; padding:30px; border-radius:10px; text-align:center; }
  #overlay input { padding:10px; width:250px; margin-top:10px; }
  #overlay button { padding:10px 20px; margin-top:10px; cursor:pointer; }
  #notification { position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; }
</style>
</head>
<body>

<div id="overlay">
  <div id="overlay-box">
    <h3>Please enter access key to continue:</h3>
    <input type="password" id="access-key" placeholder="access key">
    <br>
    <button id="access-submit">Continue</button>
  </div>
</div>

<div id="notification"></div>

<div id="sidebar" style="display:none;">
  <h3 style="text-align:center;">Files</h3>
  <div id="file-list"></div>
</div>

<div id="editor-container" style="display:none;">
  <textarea id="editor" placeholder="Select a file to load..."></textarea>
  <button id="deploy">Deploy to GitHub</button>
  <iframe id="preview"></iframe>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
let GITHUB_TOKEN = '';
const GITHUB_OWNER = 'DawidPersonal';
const GITHUB_REPO = 'domain';
const BRANCH = 'main';
let FILE_PATH = 'index.html';

const editor = document.getElementById('editor');
const preview = document.getElementById('preview');
const fileListContainer = document.getElementById('file-list');
const overlay = document.getElementById('overlay');
const sidebar = document.getElementById('sidebar');
const editorContainer = document.getElementById('editor-container');
const notification = document.getElementById('notification');

// ===== UTILS =====
function showNotification(msg, duration=3000){
  notification.textContent = msg;
  notification.style.display = 'block';
  setTimeout(()=>{ notification.style.display = 'none'; }, duration);
}

function updatePreview() {
    if(FILE_PATH.endsWith('.md')) {
        preview.srcdoc = marked.parse(editor.value);
    } else {
        preview.srcdoc = editor.value;
    }
}

// UTF-8 safe Base64
function utf8_to_b64(str) {
    return btoa(unescape(encodeURIComponent(str)));
}
function b64_to_utf8(str) {
    return decodeURIComponent(escape(atob(str)));
}

editor.addEventListener('input', updatePreview);

async function loadFile(path) {
    FILE_PATH = path;
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}?ref=${BRANCH}`, {
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
        });
        const data = await response.json();
        if(data.content){
            editor.value = b64_to_utf8(data.content);
            updatePreview();
        } else {
            editor.value = '';
            updatePreview();
        }
    } catch(err){
        console.error('Error loading file:', err);
        editor.value = '';
        updatePreview();
    }
}

async function listFiles(path=''){
    try{
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}?ref=${BRANCH}`, {
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
        });
        const files = await response.json();
        if(!Array.isArray(files)){ console.error(files); return; }
        fileListContainer.innerHTML = '';
        const editableFiles = files.filter(f=>f.type==='file' && (f.name.endsWith('.html')||f.name.endsWith('.md')));
        editableFiles.forEach(f=>{
            const btn = document.createElement('button');
            btn.textContent = f.name;
            btn.onclick = ()=>loadFile(f.name);
            fileListContainer.appendChild(btn);
        });
        if(editableFiles.length) loadFile(editableFiles[0].name);
    }catch(err){ console.error(err); }
}

// ===== DEPLOY =====
document.getElementById('deploy').addEventListener('click', async ()=>{
    try{
        const getResp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}?ref=${BRANCH}`, {
            headers:{'Authorization': `token ${GITHUB_TOKEN}`}
        });
        const existingFile = await getResp.json();
        const sha = existingFile.sha;

        const putResp = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`, {
            method:'PUT',
            headers:{'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type':'application/json'},
            body: JSON.stringify({
                message: `Update ${FILE_PATH} via Live CMS`,
                content: utf8_to_b64(editor.value),
                branch: BRANCH,
                sha: sha
            })
        });
        const result = await putResp.json();
        if(putResp.ok){
            showNotification('✅ Deployed successfully!');
        } else {
            console.error(result);
            showNotification('❌ Deployment failed!');
        }
    }catch(err){ console.error(err); showNotification('❌ Deployment error!'); }
});

// ===== ACCESS KEY =====
document.getElementById('access-submit').addEventListener('click', ()=>{
    const keyInput = document.getElementById('access-key').value.trim();
    if(keyInput===''){ alert('Please enter a valid token.'); return; }
    GITHUB_TOKEN = keyInput;
    overlay.style.display='none';
    sidebar.style.display='flex';
    editorContainer.style.display='flex';
    listFiles('');
});
</script>

</body>
</html>
